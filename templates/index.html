<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Playground</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f0f0f;
      color: #f0f0f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .banner {
      background: #1a2a1a;
      border-bottom: 1px solid #2a3a2a;
      text-align: center;
      padding: 8px 24px;
      font-size: 12px;
      color: #6abf6a;
    }

    header {
      padding: 14px 24px;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h1 { font-size: 17px; font-weight: 700; margin-right: 4px; }

    .tabs { display: flex; gap: 6px; }

    .tab {
      padding: 6px 14px;
      border-radius: 6px;
      border: 1px solid #333;
      background: transparent;
      color: #aaa;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
    }

    .tab.active { background: #333; color: #fff; border-color: #555; }

    .tab.wall-tab { border-color: #3a2a5a; color: #9a7abf; }
    .tab.wall-tab.active { background: #3a2a5a; color: #c9a9ef; border-color: #6a4a9f; }

    .btn-clear {
      margin-left: auto;
      padding: 6px 14px;
      border-radius: 6px;
      border: 1px solid #5a2020;
      background: transparent;
      color: #e05555;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
    }

    .btn-clear:hover { background: #3a1010; border-color: #e05555; }

    /* â”€â”€ AI Chat â”€â”€ */
    .chat-view {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 24px;
    }

    .content-wrap {
      width: 100%;
      max-width: 680px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 120px);
    }

    .chat-container {
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-bottom: 16px;
    }

    .message {
      max-width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      line-height: 1.6;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .message.user { background: #1e3a5f; align-self: flex-end; }
    .message.bot { background: #1e1e1e; align-self: flex-start; border: 1px solid #2a2a2a; }

    .message.bot img { max-width: 400px; border-radius: 8px; margin-top: 8px; display: block; }

    .message .label {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.05em; margin-bottom: 6px; color: #888;
    }

    .input-area { padding: 8px 0 0; display: flex; justify-content: center; }

    .input-inner { display: flex; gap: 10px; width: 100%; }

    .input-area input {
      flex: 1; padding: 12px 20px; border-radius: 24px;
      border: 1px solid #333; background: #2a2a2a;
      color: #f0f0f0; font-size: 15px; outline: none;
    }

    .input-area input:focus { border-color: #555; }

    .input-area button, .post-inner button {
      padding: 12px 24px; border-radius: 24px; border: none;
      background: #2563eb; color: #fff; font-size: 14px;
      cursor: pointer; transition: background 0.15s; white-space: nowrap;
    }

    .input-area button:hover, .post-inner button:hover { background: #1d4ed8; }
    .input-area button:disabled, .post-inner button:disabled { background: #333; cursor: not-allowed; }

    .loading { color: #666; font-style: italic; font-size: 13px; }

    /* â”€â”€ Wall â”€â”€ */
    .wall-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .post-area {
      padding: 16px 24px;
      border-bottom: 1px solid #2a2a2a;
      background: #1a1a1a;
      display: flex;
      justify-content: center;
    }

    .post-inner {
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .post-inner textarea {
      width: 100%; padding: 12px 16px; border-radius: 10px;
      border: 1px solid #333; background: #2a2a2a; color: #f0f0f0;
      font-size: 14px; font-family: inherit; resize: none; outline: none; height: 72px;
    }

    .post-inner textarea:focus { border-color: #555; }

    .post-footer { display: flex; justify-content: space-between; align-items: center; }

    .char-count { font-size: 12px; color: #555; }
    .char-count.warn { color: #e05555; }

    .wall-board {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .empty-wall {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #444;
      font-size: 15px;
      pointer-events: none;
    }

    .card {
      position: absolute;
      width: 220px;
      background: #1e1e1e;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: grab;
      user-select: none;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }

    .card:active { cursor: grabbing; }
    .card.dragging { box-shadow: 0 8px 32px rgba(0,0,0,0.7); z-index: 1000; }

    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .card-text { font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }

    .card-meta { font-size: 11px; color: #555; display: flex; justify-content: space-between; }

    .expires { color: #7a5a2a; }
    .expires.soon { color: #e05555; }

    .hidden { display: none !important; }

    /* â”€â”€ Image Attachment â”€â”€ */
    .attach-row {
      display: flex; align-items: center; gap: 8px; padding: 4px 0 0;
    }
    .attach-toggle {
      background: none; border: none; color: #666; font-size: 18px;
      cursor: pointer; padding: 0 4px; line-height: 1; flex-shrink: 0;
    }
    .attach-toggle:hover { color: #aaa; }
    .attach-input {
      flex: 1; padding: 6px 12px; border-radius: 8px; border: 1px solid #333;
      background: #2a2a2a; color: #f0f0f0; font-size: 13px; outline: none;
    }
    .attach-input:focus { border-color: #555; }
    .attach-or { color: #555; font-size: 12px; flex-shrink: 0; }
    .attach-upload-label {
      color: #888; font-size: 13px; cursor: pointer; flex-shrink: 0;
    }
    .attach-upload-label:hover { color: #bbb; }
    .attach-preview-wrap {
      display: flex; align-items: center; gap: 8px; padding: 4px 0 0;
    }
    .attach-thumb {
      height: 48px; width: 48px; object-fit: cover;
      border-radius: 6px; border: 1px solid #333;
    }
    .attach-label { font-size: 12px; color: #888; flex: 1; }
    .attach-remove {
      background: #444; border: none; color: #fff; border-radius: 50%;
      width: 20px; height: 20px; font-size: 12px; cursor: pointer;
      line-height: 20px; text-align: center; flex-shrink: 0;
    }
    .attach-remove:hover { background: #666; }
    .card-image {
      max-width: 100%; border-radius: 8px; margin-top: 6px;
      display: block; max-height: 200px; object-fit: cover;
    }

    @media (max-width: 600px) {
      header { padding: 10px 14px; gap: 6px; }
      header h1 { font-size: 14px; }
      .tab { padding: 5px 10px; font-size: 12px; }
      .btn-clear { padding: 5px 10px; font-size: 12px; }
      .chat-view { padding: 12px; }
      .content-wrap { max-height: calc(100vh - 150px); }
      .input-area input { padding: 10px 14px; font-size: 16px; }
      .post-inner textarea { font-size: 16px; }
      .attach-input { font-size: 16px; }
      .input-area button, .post-inner button { padding: 10px 16px; font-size: 13px; }
      .card { width: 160px; }

    }


  </style>
</head>
<body>
  <div class="banner">We do not collect, store, or share any of your data or conversations.</div>

  <header>
    <h1>AI Playground</h1>
    <div class="tabs">
      <button class="tab" data-mode="gpt">GPT-4o mini</button>
      <button class="tab" data-mode="image">Image Gen</button>
      <button class="tab wall-tab" data-mode="wall">The Wall</button>
    </div>
    <button class="btn-clear" id="clear">Clear</button>
  </header>

  <!-- AI Chat View -->
  <main class="chat-view" id="chatView">
    <div class="content-wrap">
      <div class="chat-container" id="chat"></div>
      <div class="input-area">
        <div class="input-inner">
          <input type="text" id="input" placeholder="Choose a model above to start..." />
          <button class="attach-toggle hidden" id="attachToggle" title="Attach image">ðŸ“Ž</button>
          <button id="send" disabled>Send</button>
        </div>
        <div class="attach-row hidden" id="attachRow">
          <input class="attach-input" id="attachUrl" placeholder="Paste image URL..." />
          <span class="attach-or">or</span>
          <label class="attach-upload-label">
            Upload <input type="file" id="attachFile" accept="image/*" style="display:none">
          </label>
        </div>
        <div class="attach-preview-wrap hidden" id="attachPreview">
          <img class="attach-thumb" id="attachThumb" src="" alt="preview">
          <span class="attach-label" id="attachLabel"></span>
          <button class="attach-remove" id="attachRemove">Ã—</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Wall View -->
  <div class="wall-view hidden" id="wallView">
    <div class="post-area">
      <div class="post-inner">
        <textarea id="wallInput" placeholder="Say something... disappears in 7 days." maxlength="280"></textarea>
        <div class="attach-row hidden" id="wallAttachRow">
          <input class="attach-input" id="wallAttachUrl" placeholder="Paste image URL..." />
          <span class="attach-or">or</span>
          <label class="attach-upload-label">
            Upload <input type="file" id="wallAttachFile" accept="image/*" style="display:none">
          </label>
        </div>
        <div class="attach-preview-wrap hidden" id="wallAttachPreview">
          <img class="attach-thumb" id="wallAttachThumb" src="" alt="preview">
          <span class="attach-label" id="wallAttachLabel"></span>
          <button class="attach-remove" id="wallAttachRemove">Ã—</button>
        </div>
        <div class="post-footer">
          <span class="char-count" id="charCount">280 left</span>
          <button class="attach-toggle" id="wallAttachToggle" title="Attach image">ðŸ“Ž</button>
          <button id="postBtn">Post</button>
        </div>
      </div>
    </div>
    <div class="wall-board" id="wallBoard"></div>
  </div>



  <script>
    let mode = null;
    let attachedImage = null;     // { url } or { b64, mime }
    let wallAttachedImage = null; // { url } or { b64, mime }
    const chatHistory = { gpt: [], image: [] };

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const chatView = document.getElementById("chatView");
    const wallView = document.getElementById("wallView");
    const attachToggle = document.getElementById("attachToggle");
    const attachRow = document.getElementById("attachRow");
    const attachPreview = document.getElementById("attachPreview");
    const attachUrl = document.getElementById("attachUrl");
    const attachFile = document.getElementById("attachFile");
    const attachThumb = document.getElementById("attachThumb");
    const attachLabel = document.getElementById("attachLabel");
    const attachRemove = document.getElementById("attachRemove");

    function clearAttachment() {
      attachedImage = null;
      attachUrl.value = "";
      attachFile.value = "";
      attachThumb.src = "";
      attachLabel.textContent = "";
      attachRow.classList.add("hidden");
      attachPreview.classList.add("hidden");
    }

    function showAttachPreview(src, label) {
      attachThumb.src = src;
      attachLabel.textContent = label;
      attachRow.classList.add("hidden");
      attachPreview.classList.remove("hidden");
    }

    attachToggle.addEventListener("click", () => {
      attachRow.classList.toggle("hidden");
    });

    attachUrl.addEventListener("keydown", e => {
      if (e.key === "Enter") { e.preventDefault(); confirmAttachUrl(); }
    });
    attachUrl.addEventListener("blur", confirmAttachUrl);

    function confirmAttachUrl() {
      const url = attachUrl.value.trim();
      if (!url) return;
      attachedImage = { url };
      showAttachPreview(url, url.length > 40 ? url.slice(0, 40) + "â€¦" : url);
    }

    attachFile.addEventListener("change", () => {
      const file = attachFile.files[0];
      if (!file) return;
      if (file.size > 4 * 1024 * 1024) { alert("Image must be under 4 MB"); attachFile.value = ""; return; }
      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        const b64 = dataUrl.split(",")[1];
        attachedImage = { b64, mime: file.type };
        showAttachPreview(dataUrl, file.name);
      };
      reader.readAsDataURL(file);
    });

    attachRemove.addEventListener("click", () => {
      clearAttachment();
      attachRow.classList.remove("hidden");
    });

    // â”€â”€ Wall attachment â”€â”€
    const wallAttachToggle  = document.getElementById("wallAttachToggle");
    const wallAttachRow     = document.getElementById("wallAttachRow");
    const wallAttachUrl     = document.getElementById("wallAttachUrl");
    const wallAttachFile    = document.getElementById("wallAttachFile");
    const wallAttachPreview = document.getElementById("wallAttachPreview");
    const wallAttachThumb   = document.getElementById("wallAttachThumb");
    const wallAttachLabel   = document.getElementById("wallAttachLabel");
    const wallAttachRemove  = document.getElementById("wallAttachRemove");

    function showWallAttachPreview(src, label) {
      wallAttachThumb.src = src;
      wallAttachLabel.textContent = label;
      wallAttachRow.classList.add("hidden");
      wallAttachPreview.classList.remove("hidden");
    }

    function clearWallAttachment() {
      wallAttachedImage = null;
      wallAttachUrl.value = "";
      wallAttachFile.value = "";
      wallAttachThumb.src = "";
      wallAttachLabel.textContent = "";
      wallAttachRow.classList.add("hidden");
      wallAttachPreview.classList.add("hidden");
    }

    wallAttachToggle.addEventListener("click", () => {
      wallAttachRow.classList.toggle("hidden");
    });

    wallAttachUrl.addEventListener("keydown", e => {
      if (e.key === "Enter") { e.preventDefault(); confirmWallAttachUrl(); }
    });
    wallAttachUrl.addEventListener("blur", confirmWallAttachUrl);

    function confirmWallAttachUrl() {
      const url = wallAttachUrl.value.trim();
      if (!url) return;
      wallAttachedImage = { url };
      showWallAttachPreview(url, url.length > 40 ? url.slice(0, 40) + "â€¦" : url);
    }

    wallAttachFile.addEventListener("change", () => {
      const file = wallAttachFile.files[0];
      if (!file) return;
      if (file.size > 4 * 1024 * 1024) { alert("Image must be under 4 MB"); wallAttachFile.value = ""; return; }
      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        const b64 = dataUrl.split(",")[1];
        wallAttachedImage = { b64, mime: file.type };
        showWallAttachPreview(dataUrl, file.name);
      };
      reader.readAsDataURL(file);
    });

    wallAttachRemove.addEventListener("click", () => {
      clearWallAttachment();
      wallAttachRow.classList.remove("hidden");
    });

    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        mode = tab.dataset.mode;

        if (mode === "wall") {
          chatView.classList.add("hidden");
          wallView.classList.remove("hidden");
          loadMessages();
        } else {
          wallView.classList.add("hidden");
          chatView.classList.remove("hidden");
          input.placeholder = mode === "image" ? "Describe an image..." : "Type a message...";
          sendBtn.disabled = false;
          if (mode === "gpt") {
            attachToggle.classList.remove("hidden");
          } else {
            attachToggle.classList.add("hidden");
            clearAttachment();
          }
          restoreHistory(mode);
          input.focus();
        }
      });
    });

    // â”€â”€ AI Chat â”€â”€
    function addMessage(text, sender, isImage = false, skipSave = false) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = sender === "user" ? "You" : mode === "gpt" ? "GPT-4o mini" : "DALL-E 3";
      div.appendChild(label);
      if (isImage) {
        const img = document.createElement("img");
        img.src = text;
        img.onerror = () => {
          img.replaceWith(Object.assign(document.createElement("span"), {
            textContent: "[Image expired]",
            style: "color:#666;font-style:italic"
          }));
        };
        div.appendChild(img);
      } else {
        div.appendChild(document.createTextNode(text));
      }
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      if (!skipSave && mode && chatHistory[mode] !== undefined) {
        chatHistory[mode].push({ sender, text, isImage });
        localStorage.setItem(`chat_${mode}`, JSON.stringify(chatHistory[mode]));
      }
      return div;
    }

    function restoreHistory(m) {
      chat.innerHTML = "";
      chatHistory[m] = JSON.parse(localStorage.getItem(`chat_${m}`) || "[]")
        .filter(msg => msg.text || msg.isImage);
      chatHistory[m].forEach(msg => addMessage(msg.text, msg.sender, msg.isImage, true));
    }

    async function send() {
      const text = input.value.trim();
      if (!text || !mode || mode === "wall") return;

      if (navigator.vibrate) navigator.vibrate(10);
      addMessage(text, "user");
      input.value = "";
      sendBtn.disabled = true;

      const loading = addMessage("", "bot", false, true);
      loading.appendChild(Object.assign(document.createElement("span"), { className: "loading", textContent: "Thinking..." }));

      try {
        let res, data;
        if (mode === "gpt") {
          const body = { message: text };
          if (attachedImage) body.image = attachedImage;
          res = await fetch("/chat/gpt", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
          data = await res.json();
          loading.innerHTML = `<div class="label">GPT-4o mini</div>`;
          loading.appendChild(document.createTextNode(data.reply));
          if (data.reply) {
            chatHistory[mode].push({ sender: "bot", text: data.reply, isImage: false });
            localStorage.setItem(`chat_${mode}`, JSON.stringify(chatHistory[mode]));
          }
        } else {
          res = await fetch("/image/generate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: text }) });
          data = await res.json();
          loading.innerHTML = `<div class="label">DALL-E 3</div>`;
          const img = document.createElement("img");
          img.src = data.url;
          loading.appendChild(img);
          if (data.url) {
            chatHistory[mode].push({ sender: "bot", text: data.url, isImage: true });
            localStorage.setItem(`chat_${mode}`, JSON.stringify(chatHistory[mode]));
          }
        }
      } catch (e) {
        loading.innerHTML = `<div class="label">Error</div>Something went wrong.`;
      }

      sendBtn.disabled = false;
      clearAttachment();
      input.focus();
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", e => { if (e.key === "Enter") send(); });

    document.getElementById("clear").addEventListener("click", () => {
      chat.innerHTML = "";
      if (mode && chatHistory[mode] !== undefined) {
        chatHistory[mode] = [];
        localStorage.removeItem(`chat_${mode}`);
      }
      fetch("/clear", { method: "POST" }).catch(() => {});
    });

    // â”€â”€ Wall â”€â”€
    const wallInput = document.getElementById("wallInput");
    const charCount = document.getElementById("charCount");
    const postBtn = document.getElementById("postBtn");
    const wallBoard = document.getElementById("wallBoard");

    const cardPositions = new Map(); // id -> {x, y}
    let topZ = 10;

    wallInput.addEventListener("input", () => {
      const left = 280 - wallInput.value.length;
      charCount.textContent = `${left} left`;
      charCount.classList.toggle("warn", left < 20);
    });

    function formatExpiry(seconds) {
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (d > 0) return `${d}d ${h}h left`;
      if (h > 0) return `${h}h ${m}m left`;
      return `${m}m left`;
    }

    function makeDraggable(card) {
      card.addEventListener("mousedown", e => {
        if (e.target.tagName === "A") return;
        e.preventDefault();
        card.classList.add("dragging");
        card.style.zIndex = ++topZ;
        const startX = e.clientX - card.offsetLeft;
        const startY = e.clientY - card.offsetTop;

        function onMove(e) {
          const x = Math.max(0, Math.min(e.clientX - startX, wallBoard.offsetWidth - card.offsetWidth));
          const y = Math.max(0, Math.min(e.clientY - startY, wallBoard.offsetHeight - card.offsetHeight));
          card.style.left = x + "px";
          card.style.top = y + "px";
          cardPositions.set(card.dataset.id, { x, y });
        }

        function onUp() {
          card.classList.remove("dragging");
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        }

        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });

      card.addEventListener("touchstart", e => {
        if (e.target.tagName === "A") return;
        e.preventDefault();
        card.classList.add("dragging");
        card.style.zIndex = ++topZ;
        const t = e.touches[0];
        const startX = t.clientX - card.offsetLeft;
        const startY = t.clientY - card.offsetTop;

        function onTouchMove(e) {
          const touch = e.touches[0];
          const x = Math.max(0, Math.min(touch.clientX - startX, wallBoard.offsetWidth - card.offsetWidth));
          const y = Math.max(0, Math.min(touch.clientY - startY, wallBoard.offsetHeight - card.offsetHeight));
          card.style.left = x + "px";
          card.style.top = y + "px";
          cardPositions.set(card.dataset.id, { x, y });
        }

        function onTouchEnd() {
          card.classList.remove("dragging");
          document.removeEventListener("touchmove", onTouchMove);
          document.removeEventListener("touchend", onTouchEnd);
        }

        document.addEventListener("touchmove", onTouchMove, { passive: false });
        document.addEventListener("touchend", onTouchEnd);
      }, { passive: false });
    }

    function renderWall(messages) {
      // Remove cards that no longer exist
      wallBoard.querySelectorAll(".card").forEach(el => {
        if (!messages.find(m => m.id === el.dataset.id)) el.remove();
      });

      if (!messages.length) {
        if (!wallBoard.querySelector(".empty-wall")) {
          wallBoard.innerHTML = `<div class="empty-wall">No messages yet. Be the first to post.</div>`;
        }
        return;
      }

      wallBoard.querySelector(".empty-wall")?.remove();

      const bw = wallBoard.offsetWidth || 800;
      const bh = wallBoard.offsetHeight || 500;

      messages.forEach(msg => {
        let card = wallBoard.querySelector(`[data-id="${msg.id}"]`);
        const soon = msg.expires_in < 1800;

        if (!card) {
          card = document.createElement("div");
          card.className = "card";
          card.dataset.id = msg.id;

          // Random position, saved so it doesn't jump on refresh
          if (!cardPositions.has(msg.id)) {
            cardPositions.set(msg.id, {
              x: Math.random() * Math.max(0, bw - 240),
              y: Math.random() * Math.max(0, bh - 140)
            });
          }
          const pos = cardPositions.get(msg.id);
          card.style.left = pos.x + "px";
          card.style.top = pos.y + "px";
          card.style.zIndex = ++topZ;
          makeDraggable(card);
          wallBoard.appendChild(card);
        }

        card.innerHTML = `
          <div class="card-text"></div>
          <div class="card-meta">
            <span>${new Date(msg.timestamp * 1000).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
            <span class="expires ${soon ? "soon" : ""}">${formatExpiry(msg.expires_in)}</span>
          </div>`;
        card.querySelector(".card-text").textContent = msg.text;
        if (msg.image_url) {
          const img = document.createElement("img");
          img.src = msg.image_url;
          img.className = "card-image";
          img.onerror = () => img.remove();
          card.querySelector(".card-text").after(img);
        }
      });
    }

    async function loadMessages() {
      const res = await fetch("/messages").catch(() => null);
      if (!res) return;
      renderWall(await res.json());
    }

    postBtn.addEventListener("click", async () => {
      const text = wallInput.value.trim();
      if (!text) return;
      if (navigator.vibrate) navigator.vibrate(10);
      postBtn.disabled = true;
      let wallImg;
      if (wallAttachedImage) {
        wallImg = wallAttachedImage.url ?? `data:${wallAttachedImage.mime};base64,${wallAttachedImage.b64}`;
      }
      const res = await fetch("/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, image_url: wallImg })
      }).catch(() => null);
      postBtn.disabled = false;
      if (res && res.ok) {
        wallInput.value = "";
        clearWallAttachment();
        charCount.textContent = "280 left";
        charCount.classList.remove("warn");
        loadMessages();
      }
    });

    wallInput.addEventListener("keydown", e => { if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) postBtn.click(); });

    document.getElementById("supportToggle").addEventListener("click", () => {
      const body = document.getElementById("supportBody");
      const toggle = document.getElementById("supportToggle");
      const open = body.classList.toggle("open");
      toggle.setAttribute("aria-expanded", open);
      toggle.querySelector(".support-chevron").textContent = open ? "â–´" : "â–¾";
    });

    setInterval(() => { if (mode === "wall") loadMessages(); }, 30000);
  </script>
</body>
</html>
